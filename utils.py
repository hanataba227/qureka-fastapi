import os
from openai import OpenAI
import tiktoken
import fitz
from pptx import Presentation
from settings import (
    API_KEY, 
    MODEL_NAME, 
    MAX_USER_MESSAGE_TOKENS,
    BASE_URL
)

# OpenAI 클라이언트 초기화
client = OpenAI(api_key=API_KEY)

# URL 관련 함수
def get_base_url():
    return BASE_URL

# PDF에서 텍스트 추출
def extract_text_from_pdf(file_path):
    text = ""
    with fitz.open(file_path) as doc:
        for page in doc:
            text += page.get_text()
    return text

# PPTX에서 텍스트 추출
def extract_text_from_pptx(file_path):
    text = ""
    prs = Presentation(file_path)
    for slide in prs.slides:
        for shape in slide.shapes:
            if hasattr(shape, "text"):
                text += shape.text + "\n"
    return text

# 토큰 제한 함수
def truncate_by_tokens(text, max_tokens, model=MODEL_NAME):
    encoding = tiktoken.encoding_for_model(model)
    tokens = encoding.encode(text)
    if len(tokens) > max_tokens:
        tokens = tokens[:max_tokens]
    return encoding.decode(tokens)

# GPT 요약 함수
def summarize_with_chatgpt(system_message, user_message):
    user_message = truncate_by_tokens(user_message, MAX_USER_MESSAGE_TOKENS)

    completion = client.chat.completions.create(
        model=MODEL_NAME,
        messages=[
            {"role": "system", "content": system_message},
            {"role": "user", "content": user_message},
        ],
        temperature=0.7,
    )

    summary = completion.choices[0].message.content
    usage = completion.usage
    return summary, usage

# 요약 프롬프트 구성
def get_summary_prompt(type_name, content):
    # 환경 변수에서 설정값 가져오기
    field = os.getenv("field", "공학")
    level = os.getenv("level", "전공자")
    sentence_count = os.getenv("sentence_count", "500")
    topic_count = os.getenv("topic_count", "2")
    keyword_count = os.getenv("keyword_count", "3")
    keywords = os.getenv("keywords", "기타,등등")
    question_count = os.getenv("question_count", "3")
    choice_count = os.getenv("choice_count", "4")
    choice_format = os.getenv("choice_format", "문장형")
    array_choice_count = os.getenv("array_choice_count", "3")
    blank_count = os.getenv("blank_count", "1")

    if isinstance(keywords, str) and "," in keywords:
        keywords = keywords.split(",")

    prompts = {
        "내용 요약_기본 요약": {
            "system": f"""너는 {field}에서 20년 경력을 지닌 요약 전문가다. 복잡한 문서의 흐름을 분석하고, 사용자의 수준에 맞게 핵심 내용을 정제하는 데 특화되어 있다.\n
                          다음 규칙을 절대적으로 따라야 한다.\n\n
                          1.[문서 분석] 단계에서는 구성과 전개 흐름을 중심으로 구간별 핵심 내용을 2-3문장으로 요약한다.\n
                          2.[통합 분석] 단계에서는 단순 요약이 아닌, 문서 구조와 키워드를 통합하여 '기술-적용-사회적 영향' 흐름에 따라 재해석하라.\n
                          3.[통합 분석] 각 구간은 반드시 {sentence_count}개의 완결된 문장으로 작성되어야 하며, 종결 표현(~다, ~이다 등)으로 끝나는 경우만 문장으로 인정한다. 쉼표로 연결된 복문은 하나의 문장으로 간주하므로, 반드시 문장을 구분하여 작성하라.\n
                          4.[통합 분석] 각 구간의 문장 수가 {sentence_count}개보다 적을 경우, GPT는 반드시 "이전 결과는 문장 수 기준을 충족하지 않아 다시 작성한다."는 문장을 출력한 후 전체를 다시 작성하라.\n
                          5.기존 표현을 복사하지 말고, 의미 단위로 재구성하여 새롭게 기술하라.\n
                          6.텍스트는 일반 텍스트로 출력하고, 마크다운 문법을 사용하지 마라.
                          \n\n\n""",
            "user": f"""문서 전체를 분석하여 흐름을 파악하고, '서론-본론-결론' 구조로 재구성하라.\n
                        출력 형식은 다음과 같다.\n\n
                        [문서 분석]\n
                        서론 - 탄소중립의 정의와 등장 배경\n
                        탄소중립은 배출한 온실가스를 다시 흡수하거나 제거함으로써 실질적 배출량을 0으로 만드는 개념으로, 기후 변화 대응을 위한 국제적 목표로 부각되고 있다.\n
                        본론 - 실천 분야와 구체적 전략\n
                        탄소중립은 에너지 전환, 친환경 교통 시스템, 건물의 에너지 효율화 같은 다양한 기술 및 정책 변화로 실현되고 있다.\n
                        결론 - 탄소중립의 확장적 의미와 필요성\n
                        탄소중립은 단순한 환경 보호를 넘어 경제 경쟁력 강화, 사회 정의 실현 등 구조적 전환을 수반하는 종합적 과제로 인식되고 있다.\n\n
                        [주요 키워드]\n
                        탄소중립 - 온실가스 배출을 실질적으로 0으로 만들기 위한 개념으로, 에너지 구조, 산업 경쟁력, 사회 정의까지 포괄하는 통합적 전환 프레임이다. 이 개념은 문서 전체에서 환경·기술·정책 변화의 방향성을 이끄는 중심 키워드로 기능한다.\n\n
                        [통합 분석]\n
                        서론 - 제목\n
                        본론 - 제목\n
                        결론 - 제목\n\n
                        -모든 출력은 {level} 수준의 학습자가 이해할 수 있도록 구성하라.\n
                        -[주요 키워드]는 문서의 중심 개념과 직접 연결되며, 문서 내용을 구성하거나 확장하는 5-10개의 키워드를 선별하고, 각 키워드는 반드시 개념의 정의, 문서 전개에서 어떤 기능을 수행하는지를 문서의 내용을 기반으로 논리적으로 설명하라.\n
                        -[통합 분석] 각 구간은 문서 구조와 키워드 간 관계를 기반으로 논리적 흐름을 갖도록 재구성하라.\n
                        -[통합 분석] 각 구간은 반드시 {sentence_count}개의 완결된 문장으로 작성되어야 하며, 쉼표로 연결된 복문은 하나로 간주하지 않는다. 문장 수가 부족할 경우 GPT는 반드시 "이전 결과는 문장 수 기준을 충족하지 않아 다시 작성한다."는 문장을 출력한 후 전체를 다시 작성하라.\n
                        -예시의 내용은 절대 출력하지 마라.
                        \n\n\n{content}""",
        },
        "내용 요약_핵심 요약": {
            "system": f"""너는 {field}에서 20년 경력을 지닌 전문가로, 다양한 분야의 방대한 문서에서 핵심만 추출하여 정보를 압축하는 데 특화되어 있다.\n
                          다음 규칙을 절대적으로 따라야 한다.\n\n
                          1.[문서 분석] 단계에서는 문서 전체에서 반복적으로 언급되거나 전체 내용을 이끄는 중심 개념 1개를 반드시 도출하라. 이때 단순히 등장 빈도보다는 내용 전개의 중심성에 주목하라.\n
                          3.[통합 분석] 단계에서는 단순한 정보 요약이 아닌, 문서 전체를 관통하는 핵심 개념을 기준으로 구조, 기술 흐름, 사회적 시사점을 통합하여 재해석한다.\n 
                          4.해당 분석은 문서 전반의 방향성과 의도를 드러내는 한 문단으로 작성되며, 내용 요약이 아니라 중심 개념을 통해 문서의 본질적 통찰을 도출하는 데 목적을 둔다.\n  
                          5.작성 결과는 단편적인 나열이 아니라, 독자가 문서의 핵심 메시지를 깊이 있게 이해할 수 있도록 구조적 전개와 개념 간 관계성을 명확히 제시해야 한다.\n
                          6.텍스트는 일반 텍스트로 출력하고, 마크다운 문법을 사용하지 마라.
                          \n\n\n""",
            "user": f"""문서 전체를 분석한 후, 아래의 형식에 따라 내용을 요약하라.\n\n
                        [문서 분석]\n
                        탄소중립은 기후 위기 대응을 위한 국제적 전략으로, 온실가스 감축을 넘어 산업·사회 전반의 구조 전환을 요구하는 핵심 개념이다.\n\n
                        [주요 키워드]\n
                        탄소중립 - 온실가스의 순배출량을 '0'으로 만드는 것을 목표로 하는 전략으로, 에너지 전환, 산업 재구조화, 사회 정의 실현까지 포함하는 전방위적 개념이다. 문서 전체에서 이 개념은 환경 정책, 기술 발전, 국제 협력 등의 내용을 유기적으로 연결하며, 지속가능한 미래를 위한 핵심 기조로 작용한다.\n                        
                        [통합 분석]\n
                        설명문\n\n
                        -모든 출력은 {level} 수준의 학습자가 이해할 수 있도록 구성하라.\n
                        -[문서 분석]는 선별한 개념이 왜 중요한지, 문서 전반의 흐름에서 어떻게 중심 축 역할을 하는지 2문장으로 작성하라.\n
                        -[주요 키워드]는 문서의 중심 개념과 직접 연결되며, 문서 내용을 구성하거나 확장하는 5-10개의 키워드를 선별하고, 각 키워드는 반드시 개념의 정의, 문서 전개에서 어떤 기능을 수행하는지를 문서의 내용을 기반으로 논리적으로 설명하라.\n
                        -[통합 분석] 각 주제 설명은은 문서 분석과 주요 키워드를 통합하여 해당 주제가 문서 흐름에 어떻게 기여하는지, 주제의 기능적 역할과 주제 간 연결성과 연계하여 주제의 중요성을 중심으로 분석하라.\n
                        -해당 작업은 문서 전체에서 도출된 핵심 개념을 바탕으로, 기술-적용-사회적 시사점이 자연스럽게 연결되도록 1문단(3~4문장)으로 작성하라.\n
                        -예시의 내용은 절대 출력하지 마라.
                        \n\n\n{content}""",
        },
        "내용 요약_주제 요약": {
            "system": f"""너는 {field}에서 20년 경력을 지닌 전문가로, 다양한 문서에서 중심 주제를 빠르게 파악하고 요약하는 데 특화된 교육 콘텐츠 기획자다.
                          다음 규칙을 절대적으로 따라야 한다.\n\n
                          1. [문서 분석] 단계에서는 문서 전반의 논리 흐름을 따라 중심 주제를 도출하라.\n
                          2. [문서 분석] 각 주제는 다음을 기준으로 중심 주제를 선별하라:\n
                              -문서의 여러 구간에서 반복적으로 연결되며 전개 흐름을 이끄는 주제\n
                              -하나 이상의 문단 또는 절이 해당 주제를 중심으로 구성되며, 정의나 설명이 포함되고, 이후 문서 전개에서 해당 주제를 기분으로 내용이 확장되거나 참조되는 경우\n
                          3. [통합 분석] 단계에서는 단순 요약이 아닌, 각 주제에 대해 문서 전반의 핵심 개념을 설명하고, 해당 주제가 어떤 기능적 역할을 수행하며, 전체 흐름에 어떻게 기여하는지를 중점으로 재해석하라.\n
                          4. [통합 분석] 단계에서는 도출된 각 주제에 대해 반드시{sentence_count}개의 완결된 문장으로 작성되어야 하며, 종결 표현(~다, ~이다 등)으로 끝나는 경우만 문장으로 인정한다. 쉼표로 연결된 복문은 하나의 문장으로 간주하므로, 반드시 문장을 구분하여 작성하라.\n
                          5. [통합 분석] 각 주제에 대한 문장 수가 {sentence_count}개보다 적을 경우, GPT는 반드시 "이전 결과는 문장 수 기준을 충족하지 않아 다시 작성한다."는 문장을 출력한 후 전체를 다시 작성하라.\n
                          6. 기존 표현을 복사하지 말고, 의미 단위로 재구성하여 새롭게 기술하라.\n
                          7. 텍스트는 일반 텍스트로 출력하고, 마크다운 문법을 사용하지 마라.
                          \n\n\n""",
            "user": f"""문서 전체를 분석한 후, 아래의 형식에 따라 내용을 요약하라.\n\n
                        [문서 분석]\n
                        주제1. 탄소중립의 개념과 글로벌 추진 배경\n
                        -탄소중립은 기후 변화 대응의 핵심 전략으로, 온실가스 감축을 넘어서 산업과 사회 전반에 걸친 구조적 전환을 요구한다. 이 주제는 문서의 시작에서부터 끝까지, 글로벌 정책과 기술 변화를 이끄는 중심 개념으로서 지속적으로 연결되며 논의된다.\n\n
                        [주요 키워드]\n
                        탄소중립 - 온실가스 배출을 실질적으로 0으로 만들기 위한 개념으로, 에너지 구조, 산업 경쟁력, 사회 정의까지 포괄하는 통합적 전환 프레임이다. 이 개념은 문서 전체에서 환경·기술·정책 변화의 방향성을 이끄는 중심 키워드로 기능한다.\n\n
                        [통합 분석]\n
                        주제1. 주제명\n
                        -통합 분석 내용\n\n
                        -모든 출력은 {level} 수준의 학습자가 이해할 수 있도록 구성하라.\n
                        -[문서 분석] 중심 주제는 {topic_count}를 도출하고, 각각 주제가 문서 내에서 어떤 기능을 수행하며 왜 중요한지를 2문장으로 작성하라.\n
                        -[주요 키워드] 문서의 중심 개념과 직접 연결되며, 문서 내용을 구성하거나 확장하는 5-10개의 키워드를 선별하고, 각 개념이 어떤 위치에 등장하며, 어떤 정보를 연결하거나 확장하며, 문서 전개에서 어떤 기능을 수행하는지를 논리적으로 설명하라.\n
                        -[통합 분석] 단계에서는 {topic_count}개 주제에 대해 각각 문서 전반의 핵심 개념을 설명하고, 어떤 기능적 역할을 수행하며, 전체 흐름에 어떻게 기여하는지를 명확히 제시해야 한다.\n
                        -[통합 분석] 단계에서 각 주제는 정확히{sentence_count}개의 완결된 문장으로 작성되어야 하며, 쉼표로 연결된 복문은 하나로 간주하지 않는다. 문장 수가 부족할 경우 GPT는 반드시 "이전 결과는 문장 수 기준을 충족하지 않아 다시 작성한다."는 문장을 출력한 후 전체를 다시 작성하라.\n
                        -예시의 내용은 절대 출력하지 마라.
                        \n\n\n{content}""",
        },
        "내용 요약_목차 요약": {
            "system": f"""너는 {field}에서 20년 경력을 지닌 요약 전문가로, 복잡한 문서를 단원 또는 목차 구조에 따라 분석하고 요약하는 데 특화되어 있다.\n
                          다음 규칙을 절대적으로 따라야 한다.\n\n
                          1.[문서 분석] 단계에서 문서에 숫자 형식의 목차(예: 1, 2 등)가 명확하게 존재하면, 그 목차를 그대로 사용하여 각 목차의 핵심 내용을 2-3문장으로 요약하라.\n
                            -이때, '1, 2 등' 형식의 목차와 '1.1, 2.1 등' 형식의 목차가 함께 존재하면 상위 항목은 '1, 2 등'이고, 하위 항목은 '1.1, 2.1 등'으로 간주하여 하위항목은 절대 포함하지 말고, 반드시 상위 항목과 통합하여 하나의 목차로 구성하라. \n
                            -이때, 문서에 명확한 숫자 기반 목차가 없거나 구조가 애매할 경우, 도입-배경-전개-결론의 4단계 구조로 나누어 각 목차의 핵심 내용을 2-3문장으로 요약하라.\n
                          2.[통합 분석] 단계에서는 단순 요약이 아닌, 문서 구조와 키워드를 통합하여 '기술-적용-사회적 영향' 흐름에 따라 재해석하라.\n
                          3.[통합 분석] 각 구간은 반드시 {sentence_count}개의 완결된 문장으로 작성되어야 하며, 종결 표현(~다, ~이다 등)으로 끝나는 경우만 문장으로 인정한다. 쉼표로 연결된 복문은 하나의 문장으로 간주하므로, 반드시 문장을 구분하여 작성하라.\n
                          4.[통합 분석] 각 구간의 문장 수가 {sentence_count}개보다 적을 경우, GPT는 반드시 "이전 결과는 문장 수 기준을 충족하지 않아 다시 작성한다."는 문장을 출력한 후 전체를 다시 작성하라.\n
                          5.기존 표현을 복사하지 말고, 의미 단위로 재구성하여 새롭게 기술하라.\n
                          6.텍스트는 일반 텍스트로 출력하고, 마크다운 문법을 사용하지 마라.
                          \n\n\n""",
            "user": f"""문서를 구성 단위별로 나누고, 각 구간의 핵심 내용을 아래의 형식에 따라 요약하라.\n\n
                        [문서 분석]\n
                        도입 - 탄소중립의 개념 정의\n
                        -탄소중립은 온실가스 배출량과 흡수량의 균형을 통해 실질적인 순배출량을 0으로 만드는 개념으로, 기후 변화 대응의 핵심 전략으로 등장했다.\n
                        배경 - 글로벌 추진과 참여 주체\n
                        -전 세계적으로 탄소중립 목표가 설정되면서, 정부, 기업, 개인이 모두 역할을 수행해야 하는 새로운 사회적 요구가 형성되었다.\n  
                        전개 - 분야별 실천 전략\n  
                        -에너지 전환, 친환경 교통, 건물 에너지 효율화 등 다양한 부문에서 기술적·정책적 변화가 동시에 추진되고 있다.\n  
                        결론 - 구조적 전환의 필요성과 전망\n  
                        -탄소중립은 단순한 환경 과제가 아니라 경제 구조, 산업 경쟁력, 사회 정의까지 포함하는 전방위적 전환을 요구한다.\n\n  
                        [키워드]\n
                        탄소중립 -  탄소중립 - 온실가스 배출을 실질적으로 0으로 만들기 위한 개념으로, 에너지 구조, 산업 경쟁력, 사회 정의까지 포괄하는 통합적 전환 프레임이다. 이 개념은 문서 전체에서 환경·기술·정책 변화의 방향성을 이끄는 중심 키워드로 기능한다.\n\n
                        [통합 분석]\n
                        도입 - 주제명\n
                        설명문\n
                        배경 - 주제명\n
                        설명문\n
                        전개 - 주제명\n
                        설명문\n
                        결론 - 주제명\n
                        설명문\n\n
                        -모든 출력은 {level} 수준의 학습자가 이해할 수 있도록 구성하라.\n
                        -[문서 분석] 단계에서는 문서에 숫자 형식으로 된 실제 목차가 존재하는 경우, 반드시 그 목차 구조를 그대로 유지하여 각 항목별로 핵심 내용을 요약하라. 도입-전개-결론 등 새로운 구조로 재구성하지 마라.\n
                        -문서에 숫자 형식으로 된 실제 목차가 존재하는 경우, 반드시 **상위 항목만** 요약하고 하위 항목은 절대 포함하지 않도록 한다. 예를 들어, '1', '2' 등 상위 항목은 포함되지만, '1.1', '2.1' 등 하위 항목은 **포함하지 않도록 한다.**\n
                        -만약 하위 항목이 포함된다면, 반드시 이를 상위 항목명으로 통합하여 요약하라.\n                       
                        -[주요 키워드] 단계에서는 [문서 분석] 단계에서 정리한 각 구간에서 핵심적으로 설명되거나, 구간의 흐름을 이끄는 키워드를 구간 당 1-2개를 반드시 선별하고, 각 키워드가 어떤 위치에 등장하며, 어떤 정보를 연결하거나 확장하며, 문서 전개에서 어떤 기능을 수행하는지를 논리적으로 설명하라.\n
                        -[주요 키워드]의 출력 형식은 반드시 '용어 - 설명'으로 하라. 절대 콜른을 사용하지 말고, 반드시 하이픈을 사용하라.\n
                        -[통합 분석] 각 구간은 문서 구조와 키워드 간 관계를 기반으로 논리적 흐름을 갖도록 재구성하라.\n 
                        -이때, '도입-제목'의 형식으로 출력하고, 제목은 반드시 해당 구간의 내용을 관통하는 핵심 주제(키워드)로 구성하라.\n 
                        -[통합 분석] 단계에서 각 목차는 정확히{sentence_count}개의 완결된 문장으로 작성되어야 하며, 쉼표로 연결된 복문은 하나로 간주하지 않는다. 문장 수가 부족할 경우 GPT는 반드시 "이전 결과는 문장 수 기준을 충족하지 않아 다시 작성한다."는 문장을 출력한 후 전체를 다시 작성하라.\n                        
                        -예시의 내용은 절대 출력하지 마라.
                        \n\n\n{content}""",
        },
        "내용 요약_키워드 요약": {
            "system": f"""너는 {field}에서 20년 경력을 지닌 전문가로, 복잡한 문서에서 지정된 키워드와 직접적으로 연결된 정보만을 추출하고, 학습 목적에 맞게 간결하고 논리적으로 재구성하는 데 특화되어 있다.\n
                          다음 규칙을 절대적으로 따라야 한다.\n\n
                          1. 모든 단계의 출력 내용은 반드시 사용자가 설정한 키워드인 {keywords}를 중심으로 구성하라.\n
                             -이때, 사용자가 설정한 {keywords}가 없고, {keyword_count}가 0개인 경우, 키워드 요약 기준이 아닌, 목차 요약 기준을 따르라.\n
                             -단, 사용자가 설정한 {keyword_count}가 없으나, {keyword_count}는 1개 이상이 경우, 문서의 중심 개념인 키워드를 {keyword_count}개 선별하고, 이를 중심으로 출력 내용을 구성하라.\n
                          2. [문서 분석] 단계에서는 도입-배경-전개-결론의 4단계 구조로 나누어 각 목차의 핵심 내용을 2-3문장으로 요약하라.\n
                          3. [통합 분석] 단계에서는 단순 요약이 아닌, 문서 구조와 키워드를 통합하여 '기술-적용-사회적 영향' 흐름에 따라 재해석하라.\n
                          4. [통합 분석] 각 구간은 반드시 {sentence_count}개의 완결된 문장으로 작성되어야 하며, 종결 표현(~다, ~이다 등)으로 끝나는 경우만 문장으로 인정한다. 쉼표로 연결된 복문은 하나의 문장으로 간주하므로, 반드시 문장을 구분하여 작성하라.\n
                          5. [통합 분석] 각 구간의 문장 수가 {sentence_count}개보다 적을 경우, GPT는 반드시 "이전 결과는 문장 수 기준을 충족하지 않아 다시 작성한다."는 문장을 출력한 후 전체를 다시 작성하라.\n
                          7. 기존 표현을 복사하지 말고, 의미 단위로 재구성하여 새롭게 기술하라.\n
                          8. 텍스트는 일반 텍스트로 출력하고, 마크다운 문법을 사용하지 마라.
                          """,
            "user": f"""문서를 구성 단위별로 나누고, 각 구간의 핵심 내용을 아래의 형식에 따라 요약하라.\n\n
                        [문서 분석]\n
                        도입 - 주제명\n
                        키워드의 정의와 문서 도입부 등장 맥락을 나타내는 설명문\n
                        배경 - 주제명\n
                        키워드가 등장하게 된 기술적/사회적/개념적 필요성을 나타내는 설명문\n
                        전개 - 주제명\n
                        문서에서 키워드를 중심으로 어떤 방식으로 논의되었는지를 나타내는 설명문\n
                        결론 - 주제명\n
                        문서 전체에서 키워드가 제시하는 시사점, 확장 가능성, 결론적 평가를 나타내는 설명문\n\n
                        [주요 키워드]\n\
                        탄소중립 -  탄소중립 - 온실가스 배출을 실질적으로 0으로 만들기 위한 개념으로, 에너지 구조, 산업 경쟁력, 사회 정의까지 포괄하는 통합적 전환 프레임이다. 이 개념은 문서 전체에서 환경·기술·정책 변화의 방향성을 이끄는 중심 키워드로 기능한다.\n\n
                        [통합 분석]\n\n
                        도입 - 주제명\n
                        설명문\n
                        배경 - 주제명\n
                        설명문\n
                        전개 - 주제명\n
                        설명문\n
                        결론 - 주제명\n
                        설명문\n\n
                         -모든 출력은 {level} 수준의 학습자가 이해할 수 있도록 구성하라.\n
                        -[주요 키워드] 단계에서는 사용자가 설정한 {keywords} 중 문서와 직접적으로 관련된 키워드만을 선별하여 출력하고, 문서와 무관한 키워드는 절대 출력하지 마라. \n
                        -관련이 없는 키워드의 출력은 기존 구조인 '키워드명과 설명을 공백으로 출력하라.\n
                        -[주요 키워드]의 출력 형식은 반드시 '용어 - 설명'으로 하라. 절대 콜론을 사용하지 말고, 반드시 하이픈을 사용하라.\n
                        -[통합 분석] 각 구간은 문서 구조와 키워드 간 관계를 기반으로 논리적 흐름을 갖도록 재구성하라.\n 
                        -이때, '구간 항목-제목'의 형식으로 출력하고, 제목은 반드시 해당 구간의 내용을 관통하는 핵심 주제(키워드)로 구성하라.\n 
                        전체 요약은 {level} 수준 학습자가 쉽게 이해할 수 있도록 구성하되, {sentence_count}개의 완결된 문장으로 작성하라.
                        -[통합 분석] 단계에서 각 목차는 정확히{sentence_count}개의 완결된 문장으로 작성되어야 하며, 쉼표로 연결된 복문은 하나로 간주하지 않는다. 문장 수가 부족할 경우 GPT는 반드시 "이전 결과는 문장 수 기준을 충족하지 않아 다시 작성한다."는 문장을 출력한 후 전체를 다시 작성하라.\n                        
                        -예시의 내용은 절대 출력하지 마라.
                        \n\n\n{content}""",
        },
        "문제 생성_n지 선다형": {
            "system": f"너는 {field}에서 20년 경력을 지닌 평가 설계 전문가로, {level} 수준의 학습자를 위한 객관식 문제를 설계하는 데 특화되어 있다.",
            "user": f'''학습자의 핵심 개념 이해, 용어 정의, 개념 간 비교 및 오류 식별 능력을 점검할 수 있도록 {choice_count}지선다형 문제를 생성하라.\n
                        혼동 가능한 오답을 포함해 학습자의 개념적 정확성과 구분 능력을 평가할 수 있도록 구성하라.\n
                        문제 생성 형식은 다음을 따르라.\n\n
                        문제1. 인조 나뭇잎의 내부 수분 흐름을 원활하게 하기 위해 사용된 구조 형성 기법은 무엇인가?\n\n
                           1. 일반 겔 형성법\n
                           2. 표면 산화 처리\n
                           3. cryo-gel 기법\n
                           4. 초음파 세척법\n\n
                        [정답] 3번\n\n
                        [해설] 
                        이 문항은 인조 나뭇잎의 수분 이송 성능 향상을 위한 구조 형성 기술을 묻고 있다. cryo-gel 기법은 저온에서 겔을 형성하며 마이크로 채널 구조를 통해 유동 저항을 감소시킨다. 일반 겔은 미세 구조 형성 기능이 부족하고, 표면 산화 처리는 표면 개질에는 효과적이나 내부 유동과는 무관하다. 초음파 세척법은 이물질 제거에 사용될 뿐 구조 형성과 관련 없다.\n
                        cryo-gel 기법은 구조 제어 기반 수분 흐름 조절 장치에 응용된다. 따라서 정답은 3번이다.\n\n
                        -문제의 내용은 반드시 요약 결과를 바탕으로 구성하고, 출제 난이도는 {level}을 기준으로 출제하라.\n
                        -문제의 수는 반드시 {question_count}개만 생성하라.\n
                        -지시문의 문장 구조는 한 형식으로만 고정하지 말고 다양한 구조를 활용하라.\n
                        -보기는 반드시 {choice_count}개만 생성하라.\n
                        -해설문은 다음의 기준을 모두 포함하여 작성하라.\n
                          1.지문과 정답 간 논리적 연결\n
                          2.정답 개념의 정의와 역할\n
                          3.각 오답과의 비교 분석 및 틀린 이유 설명\n
                          4.해당 개념이 사용될 수 있는 실제 응용 예시\n
                        -이때, 해설문은 학습자가 왜 정답이 맞고, 다른 선택지가 틀렸는지를 이해할 수 있도록 자세한 오답 풀이로 구성하여야 하며, 오답 설계 포인트와 혼동 지점을 반드시 제시하라.\n
                        -해설문의 결론은 무조건 '따라서 정답은 ~이다.'로 구성하여라.\n
                        -반드시 텍스트는 모든 일반 텍스트로 처리하고, '[]'를 제외한 마크다운 형식의 표현은 절대 사용하지 마라. 특히, '---'과 같은 구분선을 절대 출력하지 마라.\n
                        -출력 문장의 종결 어미는 반드시 '~한다', '~이다' 등 비격식체 서술형 어미로 통일하라. 절대'-합니다', '-입니다' 등 격식체 종결어미는 절대 사용하지 말고, 문체는 일관되게 보고서식 비격식체로 유지하라.
                        \n\n\n{content}'''
        },
        "문제 생성_순서 배열형": {
            "system": f"너는 {field}에서 20년 경력을 지닌 평가 설계 전문가로, {level} 수준의 학습자를 위한 논리적 흐름, 절차적 지식의 이해를 평가하는 배열형 문항을 설계하는 데 특화되어 있다.",
            "user": f'''학습자가 제시된 선택지를 올바른 순서대로 배열함으로써 개념의 구조와 전개 흐름을 논리적으로 이해했는지를 점검할 수 있도록 배열 문제를 구성하라.\n
                        문제 생성 형식은 다음을 따르라.\n\n
                        문제1. 아래는 인조 나뭇잎 기반 무동력 펌프 제작 및 검증 실험의 절차이다. 보기를 읽고, 실험의 전체 흐름을 구조적으로 이해하여 가장 적절한 순서로 배열하시오.\n\n
                        문제1. 다음 보기들을 논리적 흐름에 따라 올바르게 배열하시오.\n
                        1. cryo-gel 기법을 적용하여 마이크로 채널 구조를 형성한다.\n
                        2. Agarose gel을 사용하여 겔 기반 구조를 형성한다.\n
                        3. 제작된 인조 나뭇잎의 수분 이송 성능을 분석하는 실험을 수행한다.\n\n
                        [정답] 2-1-3\n
                        [해설]\n
                        이 문항은 무동력 펌프 시스템 구현을 위한 인조 나뭇잎의 제작과 검증 절차를 바르게 이해했는지를 평가한다.\n
                        보기 2는 실험의 기초 재료 준비 단계이며, Agarose gel은 기초 겔 구조 형성을 위한 필수 재료다. 그다음 보기 1은 cryo-gel 기법을 활용해 마이크로 채널 구조를 만드는 세부 제작 단계이며, 마지막 보기 3은 실제 제작된 구조의 기능성을 검증하는 실험 단계이다.\n
                        오답으로 자주 등장하는 1-2-3의 경우, cryo-gel을 먼저 적용하려는 오류가 있으나, 기초 겔이 없는 상태에서는 구조가 형성되지 않아 순서상 타당하지 않다.\n
                        따라서 정답은 2-1-3이다.\n
                        -문제의 내용은 반드시 요약 결과를 바탕으로 구성하고, 출제 난이도는 {level}을 기준으로 출제하라.\n
                        -문제의 수는 반드시 {question_count}개만 생성하라.\n
                        -지시문의 문장 구조는 "다음 보기들을 순서대로 배열하시오." 등 예시의 형식으로만 고정하지 말고, 반드시 다양한 구조를 활용하라.\n
                        -보기의 수는 반드시 {array_choice_count}개만 생성하라.\n
                        -해설문은 다음의 기준을 모두 포함하여 작성하라.\n
                          1.각 보기의 의미와 기능 설명\n
                          2.보기 간 인과 관계 또는 흐름 설명\n
                          3.자주 발생하는 오답 순서와 그 오류 이유 설명\n
                        -이때, 해설문은 제시된 정답의 순서가 왜 옳은지를 기반으로 과정을 중점으로 해설하고,  오답 설계 포인트와 혼동 지점을 반드시 제시하라.\n
                        -해설문의 결론은 무조건 '따라서 정답은 ~이다.'로 구성하여라.\n
                        -반드시 텍스트는 모든 일반 텍스트로 처리하고, '[]'를 제외한 마크다운 형식의 표현은 절대 사용하지 마라. 특히, '---'과 같은 구분선을 절대 출력하지 마라.\n
                        -출력 문장의 종결 어미는 반드시 '~한다', '~이다' 등 비격식체 서술형 어미로 통일하라. 절대'-합니다', '-입니다' 등 격식체 종결어미는 절대 사용하지 말고, 문체는 일관되게 보고서식 비격식체로 유지하라.
                        \n\n\n{content}'''
        },
        "문제 생성_참거짓형": {
            "system": f"너는 {field}에서 20년 경력을 지닌 평가 설계 전문가로, {level} 수준의 학습자를 위한 논리적 흐름, 절차적 지식의 이해를 평가하는 침거짓형 문항을 설계하는 데 특화되어 있다.",
            "user": f'''학습자가 문장에 포함된 정보가 정확한지, 오개념을 구별할 수 있는지 등을 검토할 수 있도록 참거짓형 문제를 생성하라.\n
                       문제 생성 형식은 다음을 따르라.\n\n
                        문제1. 다음 진술문을 읽고, 옳으면 O, 틀리면 X로 표시하시오.\n
                        인조 나뭇잎의 cryo-gel 기법은 표면 장력 감소를 통해 증발률을 증가시키기 위해 사용된다. (O, X)\n\n
                        [정답] X\n\n
                        [해설]
                        cryo-gel 기법은 수분 증발을 직접 촉진하는 것이 아니라, 내부에 마이크로 채널 구조를 형성하여 유동 저항을 낮추는 방식으로 수분 이송을 용이하게 한다. 표면 장력 감소는 주된 목적이 아니다. 따라서 정답은 X이다.\n\n
                        -문제의 내용은 반드시 요약 결과를 바탕으로 구성하고, 출제 난이도는 {level}을 기준으로 출제하라.\n
                        -문제의 수는 반드시 {question_count}개만 생성하라.\n
                        -지시문의 문장 구조는 반드시 "다음 진술문을 읽고, 옳으면 O, 틀리면 X로 표시하시오."로 출력하라. 이외 다른 항목과 절대 결합하지 마라.\n
                        -해설문은 다음의 기준을 모두 포함하여 작성하라.\n
                          1.진위 판별의 핵심 개념 정리\n
                          2.왜 참/거진인지 판단하는 조건 설명\n
                          3.오답과의 비교\n
                        -이때, 해설문은 진위문의 표현이 왜 맞고 틀렸는지를 중심으로 핵심 문장 또는 단어를 통해 정답을 유추할 수 있도록 구성하고, 오답 설계 포인트와 혼동 지점을 반드시 제시하라.\n
                        -해설문의 결론은 무조건 '따라서 정답은 ~이다.'로 구성하여라.\n
                        -반드시 텍스트는 모든 일반 텍스트로 처리하고, '[]'를 제외한 마크다운 형식의 표현은 절대 사용하지 마라. 특히, '---'과 같은 구분선을 절대 출력하지 마라.\n
                        -출력 문장의 종결 어미는 반드시 '~한다', '~이다' 등 비격식체 서술형 어미로 통일하라. 절대'-합니다', '-입니다' 등 격식체 종결어미는 절대 사용하지 말고, 문체는 일관되게 보고서식 비격식체로 유지하라.
                        \n\n\n{content}'''
        },
        "문제 생성_빈칸 채우기형": {
            "system": f"너는 {field}에서 20년 경력을 지닌 평가 설계 전문가로, {level} 수준의 학습자를 위한 논리적 흐름, 절차적 지식의 이해를 평가하는 빈칸채우기형 문항을 설계하는 데 특화되어 있다.",
            "user": f'''학습자가 문맥 속 개념이나 핵심 용어를 정확히 이해하고 적용할 수 있는지를 점검할 수 있도록 빈칸 채우기형 문제를 생성하라.\n
                        문제 생성 형식은 다음을 따르라.\n\n
                        문제1. 다음 문장을 읽고, 빈칸에 알맞은 용어를 쓰시오.\n\n
                        연구팀은 인조 나뭇잎 내부에 미세한 유로를 만들기 위해 (1)_____을 적용하였고, 이로 인해 수분 흐름 경로가 확장되어 (2)_____이 감소하였다.\n\n
                        [정답] (1) cryo-gel 기법, (2) 유동 저항\n
                        [해설]
                        이 문항은 인조 나뭇잎의 내부 구조를 제어하여 수분 이송 성능을 향상시키기 위한 기술과 그 효과를 묻고 있다.\n
                        (1)은 '미세한 유로를 만든다', (2)는 '감소하였다'라는 표현을 통해 각각 구조 형성 기술과 그 결롸로 나타나는 물리적 현상을 유추할 수 있다. (1)의 'cryo-gel 기법'은 낮은 온도에서 겔을 형성하며, 내부에 마이크로 채널 구조를 정밀하게 생성할 수 있는 기술로, 이 기법을 적용하면 물이 흐르는 통로가 만들어져 수분 이동이 원활해진다.\n (2)의 '유동 저항'은 물이 구조 내에서 이동할 때 받는 저항을 의미하며, cryo-gel 기법을 통해 생성된 구조는 이 저항을 줄이는 데 효과적이다.\n
                        따라서 정답은 (1) cryo-gel 기법, (2) 유동 저항이다.\n\n 
                        -문제의 내용은 반드시 요약 결과를 바탕으로 구성하고, 출제 난이도는 {level}을 기준으로 출제하라.\n
                        -문제의 수는 반드시 {question_count}개만 생성하라.\n
                        각 문제는 빈칸을 반드시 {blank_count}개만 생성하라.\n
                        -지시문의 문장 구조는 반드시 "다음 문장을 읽고, 빈칸에 알맞은 용어를 쓰시오"만 출력하라. 이외 다른 항목과 절대 결합하지 마라.\n
                        -빈칸문은 문제 당 하나의 문단 또는 여러 문장으로 구성된 지문이며, 문맥상 핵심 개념이 빠진 빈칸을 포함한다. 이때, 빈칸은 반드시(1)_____, (2)_____의 형식으로 작성하라. 이외의 다른 형태의 빈칸을 생성하지 마라. 특히, '___(1)__, ____ 등'과 같은 형식으로 절대 출력하지 마라.\n
                        -해설문은 다음의 기준을 모두 포함하여 작성하라.\n
                          1. 문맥상 정답의 기능 설명\n
                          2. 정답 개념 정의 및 지문과의 논리적 연결을 강조한 정답의 주요 특징\n
                          3. 오답과 비교를 통한 개념적 구분 유도\n
                        -이때, 해설문은 제시된 정답이 빈칸에 들어가야 하는지를 중심으로 문장 흐름과 어울리는 개념 선택을 유도할 수 있도록 구성하고, 오답 설계 포인트와 혼동 지점을 반드시 제시하라.\n
                        -해설문의 결론은 무조건 '따라서 정답은 ~이다.'로 구성하여라.\n
                        -반드시 텍스트는 모든 일반 텍스트로 처리하고, '[]'를 제외한 마크다운 형식의 표현은 절대 사용하지 마라. 특히, '---'과 같은 구분선을 절대 출력하지 마라.\n
                        -출력 문장의 종결 어미는 반드시 '~한다', '~이다' 등 비격식체 서술형 어미로 통일하라. 절대'-합니다', '-입니다' 등 격식체 종결어미는 절대 사용하지 말고, 문체는 일관되게 보고서식 비격식체로 유지하라.                       
                        \n\n\n{content}'''
        },
        "문제 생성_단답형": {
            "system": f"너는 {field}에서 20년 경력을 지닌 평가 설계 전문가로, {level} 수준의 학습자를 위한 논리적 흐름, 절차적 지식의 이해를 평가하는 단답형 문항을 설계하는 데 특화되어 있다.",
            "user": f'''문제 출력 형식은 아래의 예시와 같이 구성하라.\n\n
                       문제 생성 형식은 다음을 따르라.\n\n
                        문제1. 인조 나뭇잎의 수분 이송 능력을 향상시키기 위해 도입된 기법으로, 마이크로 채널 구조를 형성해 유동 저항을 줄이는 데 기여하는 기술은?\n
                        [정답] cryo-gel 기법\n
                        [해설] 
                        이 문제는 수분 이송 효율 향상이라는 목적 하에 사용된 기술을 묻고 있다. 문장 속 '마이크로 채널', '유동 저항 감소'라는 단서를 통해 구조적 제어가 가능한 기술이 정답임을 유추할 수 있다.\n
                        cryo-gel 기법은 낮은 온도에서 겔을 형성해 미세한 통로 구조를 만들 수 있는 기술로, 내부에서 물이 흐르기 쉬운 환경을 제공한다. 유사 개념인 일반적인 'Gel 기술'은 이처럼 정밀한 구조를 만들기 어렵고, 'Agarose gel'은 재료일 뿐, 구조 형성 기법은 아니다.\n
                        따라서 정답은 cryo-gel 기법이다.\n\n
                        -문제의 내용은 반드시 요약 결과를 바탕으로 구성하고, 출제 난이도는 {level}을 기준으로 출제하라.\n
                        -문제의 수는 반드시 {question_count}개만 생성하라.\n
                        -지시문은 학습자가 개념을 단순 회상하는 수준을 넘어서, 문제 상황이나 흐름을 이해하고 정답을 유추할 수 있도록 구성하라.\n
                        -이때, 지시문의 문장 구조는 "~은 무엇인가?", "~을 쓰시오.", "~에 해당하는 개념은?"과 같은 고정형 문장만 사용하지 말고, 반드시 상황형, 기능형, 원인-결과형 등 다양한 구조로 변형하여 출제하라.\n
                        -정답은 문장이 아닌 단어나 짧은 구나 숫자로 구성하고, 용어, 개념, 키워, 숫자 중심으로 마침표 없이 간결하게 작성한다.\n
                        -해설문은 다음의 기준을 모두 포함하여 작성하라.\n
                          1.문제에서 제시된 맥락 또는 조건을 바탕으로 정답을 유추하는 과정 설명\n
                          2.정답이 왜 적절한지에 대한 논리적 이유와, 문제 맥락에서 수행하는 역할 또는 특징징\n
                          3.정답 개념의 정확한 정의 또는 설명\n
                          4.해당 개념이 문제 상황에서 어떻게 적용되는지를 서술\n
                          5.자주 혼동되는 유사 개념과 비교하여 오답의 이유를 설명\n 
                        -이때, 해설문은 제시된 정답이 옳은지를를 중심으로 문제의 목적을 통해 정답을 유도할 수 있도록 구성하고, 오답 설계 포인트와 혼동 지점을 반드시 제시하라.\n                        
                        -해설문의 결론은 무조건 '따라서 정답은 ~이다.'로 구성하여라.\n
                        -반드시 텍스트는 모든 일반 텍스트로 처리하고, '[]'를 제외한 마크다운 형식의 표현은 절대 사용하지 마라. 특히, '---'과 같은 구분선을 절대 출력하지 마라.\n
                        -출력 문장의 종결 어미는 반드시 '~한다', '~이다' 등 비격식체 서술형 어미로 통일하라. 절대'-합니다', '-입니다' 등 격식체 종결어미는 절대 사용하지 말고, 문체는 일관되게 보고서식 비격식체로 유지하라. 
                        \n\n\n{content}'''
        },
        "문제 생성_서술형": {
            "system": f"너는 {field}에서 20년 경력을 지닌 평가 설계 전문가로, {level} 수준의 학습자를 위한 논리적 흐름, 절차적 지식의 이해를 평가하는 서술형 문항을 설계하는 데 특화되어 있다.",
            "user": f'''학습자가 핵심 개념, 절차, 원리를 자신의 언어로 정확하고 일관되게 설명하는 능력을 평가할 수 있도록 서술형 문제를 구성하라.\n
                       문제 생성 형식은 다음을 따르라.\n\n
                        문제1. 인조 나뭇잎 연구에서 cryo-gel 기법이 수분 이송 성능 향상에 어떻게 기여하는지를 설명하시오.\n
                        [정답] cryo-gel 기법은 저온 환경에서 겔을 형성함으로써 내부에 미세한 채널 구조를 만들어낸다. 이러한 구조는 인조 나뭇잎 내부에서 수분이 통과할 수 있는 유로 역할을 하며, 유동 저항을 줄여 물의 이송을 보다 원활하게 만든다. 결과적으로 수분의 전달 속도와 효율이 향상되므로, cryo-gel 기법은 인조 나뭇잎의 수분 이송 성능을 개선하는 데 핵심적인 역할을 한다.\n
                        [해설]\n
                        이 문항은 cryo-gel 기법의 기술적 원리와 수분 이송 성능 간의 인과적 연관성을 논리적으로 설명할 수 있는지를 평가한다.\n 
                        cryo-gel 기법은 저온에서 겔을 형성하여 마이크로 채널 구조를 만들 수 있는 기술로, 인조 나뭇잎 내부에 수분이 흐를 수 있는 정밀한 유로를 생성하는 데 사용된다. 이러한 구조는 유동 저항을 줄여 수분 이송을 촉진하며, 결과적으로 전체 시스템의 효율을 높인다. 학습자가 오답을 서술할 수 있는 예로는, cryo-gel 기법을 단순히 재료라고 기술하거나, 겔 형성만 언급하고 유동 저항과의 관계를 설명하지 않는 경우가 있다. 또한, 기법 자체의 정의에만 머무르고 성능 향상과 연결짓지 못하는 경우도 자주 발생한다.\n
                        따라서 답안 작성 시에는 cryo-gel의 구조 형성 기능과 수분 흐름 간의 관계를 중심으로 명확히 설명해야 한다.\n
                        이 문항의 채점 기준은 다음과 같다.\n
                        -cryo-gel 기법의 원리(저온 겔화, 미세 구조 형성)를 서술하였는가\n
                        -수분 유로 확보 및 유동 저항 감소와의 연관성을 설명하였는가\n  
                        -인조 나뭇잎 내 수분 흐름과의 관계를 구체적으로 기술하였는가\n\n
                        -문제의 내용은 반드시 요약 결과를 바탕으로 구성하고, 출제 난이도는 {level}을 기준으로 출제하라.\n
                        -문제의 수는 반드시 {question_count}개만 생성하라.\n
                        -지시문의 문장 구조는 "~의 개념과 주요 특징을 서술하시오.?", "~에 대한 자신의 견해를 서술하시오.", "~의 차이점을 서술하시오?" 등 예시의 형식으로만 고정하지 말고, 반드시 다양한 구조를 활용하라.\n
                        -정답은 학습자가 자신의 응답과 비교하여 핵심 개념 이해, 논리적 설명력, 구조화 수준을 점검할 수 있도록 구성된 피드백형 예시로 구성하라.\n
                        -해설문은 다음의 기준을 모두 포함하여 작성하라.\n
                          1. 문제에서 요구한 설명의 범위(개념, 사례, 비교 등)를 간략히 요약하고, 평가의 핵심 목적을 제시하라.\n
                          2. 정답 서술이 반드시 포함해야 할 핵심 개념 또는 필수 요소를 명확히 정리하라.\n
                          3. 해당 개념이 왜 중요한지, 어떤 원리나 사례와 연결되는지를 서술하라.\n
                          4. 자주 발생하는 오개념 또는 학습자의 서술상 오류를 제시하고, 이를 구분할 수 있도록 설명하라.\n
                          5. 학습자가 자기 답안을 점검할 수 있도록 채점 기준을 항목별로 간단하게 제시하라. 
                          6. 해설은 정답의 근거, 관련 개념 간의 연결, 오개념과의 구분 등을 포함해 학습 효과를 높이도록 구성하라.\n\n
                        -반드시 텍스트는 모든 일반 텍스트로 처리하고, '[]'를 제외한 마크다운 형식의 표현은 절대 사용하지 마라. 특히, '---'과 같은 구분선을 절대 출력하지 마라.\n
                        -출력 문장의 종결 어미는 반드시 '~한다', '~이다' 등 비격식체 서술형 어미로 통일하라. 절대'-합니다', '-입니다' 등 격식체 종결어미는 절대 사용하지 말고, 문체는 일관되게 보고서식 비격식체로 유지하라. 
                        \n\n\n{content}'''
        }
    }

    return prompts.get(type_name, {"system": "", "user": ""})
